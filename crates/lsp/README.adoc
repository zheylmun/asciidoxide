= asciidoxide-lsp
:url-repo: https://github.com/zheylmun/asciidoxide
:url-lsp-spec: https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification
:url-tower-lsp: https://github.com/ebkalderon/tower-lsp

Language Server Protocol implementation for https://asciidoc.org[AsciiDoc], built on the link:../parser/[asciidoxide-parser].

== Installation

[source,bash]
----
cargo install --path crates/lsp
----

The binary `asciidoxide-lsp` communicates over stdin/stdout using the LSP protocol.
Editor extensions (such as the link:../../editors/zed/[Zed extension]) discover it in `PATH`.

== Roadmap

[cols="2,4,1,1"]
|===
| Feature | Description | Phase | Status

4+h| Foundation

| Text document sync
| Full document sync on open, change, and close
| —
| Done

| Diagnostics
| Real-time parse errors and warnings published on every edit
| —
| Done

4+h| Phase 1: Navigation

| Document symbols
| Document outline as a nested symbol hierarchy. Sections with level/title/range, blocks as children of their containing section. Uses `block.name`, `block.level`, `block.title`.
| 1
| Planned

| Folding ranges
| Collapse structural regions. Sections fold to the next sibling, delimited blocks (`block.delimiter`) fold between fences, lists fold from first to last item.
| 1
| Planned

| Go to definition
| Navigate from `\<<target>>` cross-references to the block with the matching `id`. `RefNode(variant: "xref")` → `Block(id)` lookup.
| 1
| Planned

4+h| Phase 2: Intelligence

| Hover
| Contextual info on hover. Section headings: level, ID, roles/options. Cross-references: resolved target title and location. Attribute references: current value. Inline macros: target and parameters.
| 2
| Planned

| Completion
| Context-aware suggestions. `\<<` triggers xref target completion from block IDs. `{` triggers attribute name completion. Attribute lists suggest valid styles (`source`, `quote`, `verse`, `abstract`, `appendix`, etc.). Include targets suggest relative file paths.
| 2
| Planned

| Find references
| Given a block ID, find all `RefNode` cross-references targeting it. Reveals how sections and anchors are linked within a document.
| 2
| Planned

4+h| Phase 3: Editing Support

| Code actions
| Quick fixes tied to diagnostics. Unresolved xref → create target anchor. Auto-generated ID referenced → suggest adding explicit ID.
| 3
| Planned

| Rename
| Rename a block ID and update all cross-references pointing to it. Shares the ID-to-xref index with go-to-definition and find-references.
| 3
| Planned

| Formatting
| Basic formatting support. Normalize list markers, heading styles, and attribute list spacing. Integrate with a dedicated formatter when one exists.
| 3
| Planned

4+h| Phase 4: Semantic Tokens

| Inline spans
| Classify `SpanNode` variants (`strong`, `emphasis`, `code`, `mark`, `superscript`, `subscript`) and forms (`constrained` vs `unconstrained`) as distinct token types.
| 4
| Planned

| Links and cross-references
| Distinguish `RefNode` variants (`link` vs `xref`). Separately classify target and display text.
| 4
| Planned

| Passthroughs
| Mark `RawNode` content so editors visually distinguish passthrough regions.
| 4
| Planned

| Block metadata
| Classify roles, options, and attribute key/value pairs in block attribute lists.
| 4
| Planned

4+h| Phase 5: Multi-file and Workspace

| Workspace symbols
| Index block IDs and section titles across all open documents. Cross-file go-to-definition for inter-document cross-references.
| 5
| Planned

| Include resolution
| Resolve `include::` directives. Diagnostics for missing files, go-to-definition into included content, cross-file symbol indexing.
| 5
| Planned

| Code lens
| Display reference counts inline above block IDs, showing how many cross-references point to each anchor.
| 5
| Planned
|===

== Architecture

[source,text]
----
main.rs        Entry point: stdin/stdout transport via tower-lsp
lib.rs         Module exports
backend.rs     LanguageServer trait implementation, document lifecycle
document.rs    Self-referential document storage (self_cell), on-demand SourceIndex
diagnostics.rs ParseDiagnostic → LSP Diagnostic conversion
----

The server re-parses the full document on every change (`TextDocumentSyncKind::FULL`).
The ASG and diagnostics are cached in a `DashMap<String, DocumentState>` keyed by document URI.
`SourceIndex` is constructed on demand when converting byte-offset spans to LSP positions.

== License

Licensed under either of link:../../LICENSE-APACHE[Apache License, Version 2.0] or link:../../LICENSE-MIT[MIT license] at your option.
